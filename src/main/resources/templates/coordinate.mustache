<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>spot Coordinate</title>

</head>
<body>
<form method="POST" action="/coordinate">
    <div class="form-group">
    <p><label>CropsName : <input type="text" name="cropsName" id="cropsName"></label></p>
    <p><label>Latitude : <input type="text" name="latitude"></label></p>
    <p><label>Longitude : <input type="text" name="longitude"></label></p>
    <p><input type="submit" value="Submit"></p>
    </div>
</form>

<button id="Measure"> Crops Measurement </button>
<button id="termination">Termination</button>
<button id="remove">Remove</button>
<button id="save">Save</button>
<button id="marking">Marking</button>
<div id="map" style="width:100%; height: 100vh;"></div>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBH0-lnC8QZgYZ4l1_2qw0NiYJMUizykrE&callback=initMap&region=kr"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <div id="myCoordinate"></div>
<script type="text/javascript">
let measurement;
let map;
let malls;
//const name = document.getElementById("cropsName").value;

$(document).ready(function () {
    $('#Measure').on('click', function () {
        measurement = setInterval(() => window.navigator.geolocation.getCurrentPosition(success, error), 5000);
    })
});
$(document).ready(function () {
    $('#termination').on('click', function () {
        clearInterval(measurement);
    })
});

function success(position){
    console.log("correct")
    $('#myCoordinate').append("<p>"+ "<input type=\"checkbox\" name = \"Chk\">"
            + "cropsName : "+ document.getElementById("cropsName").value + ", " +
            "latitude : " + position.coords.latitude + ", " +
            "longitude : " + position.coords.longitude + "<label hidden>OK</label></p>");
}

function error(err){
    $('#myCoordinate').text("조회 실패 ==>" + err.code);
}

$('#remove').click(function() {
    if ($("input:checkbox[name='Chk']:checked").length === 0) {
        alert("삭제할 항목을 선택해 주세요.");
        return;
    }

    $("input:checkbox[name='Chk']:checked").each(function(k,kVal){
        console.log("kVal ::", kVal.parentElement);
        let a = kVal.parentElement;
        $(a).remove();
    });
});
function parsing(data)
{
        let json = data;
    json = json.toString().replace(/\"item\":/gi, "");
    json = json.toString().replace(/,{\"\"}/gi, "");
    json = json.toString().replace(/ /gi, "");
    json = json.toString().replace(/:/gi, "\" : \"");
    json = json.toString().replace(/,/gi, "\", \"");
    json = json.toString().replace(/\"{/gi, "{");
    json = json.toString().replace(/}\"/gi, "}");
        //let json2 = "{ \"item\": " + json;
        //let word = "}";
        //json2 = json2.concat(word);
        let Obj = JSON.parse(json);
        //console.log(Obj);
    return Obj;
}
function bring_myCoordinate(button_id, url)
{
    $(button_id).click(function(){   //submit 버튼을 클릭하였을 때
        let sendData = $('#myCoordinate').text();   //폼의 이름 값을 변수 안에 담아줌
        let sendData_list = sendData.split("OK");
        let digit = [];

        sendData_list.forEach((item, index) => {
            digit.push({item});
        });
        let parsingData = parsing(JSON.stringify(digit));
        //console.log(sendData_list);
        $.ajax({
            method: 'post',
            url: url,
            traditional: true,
            data: {
                data: JSON.stringify(digit)
            },
            success     :   function(retVal){
                //let retVal_text = retVal.text();
                  console.log('retVal_log');
                if(retVal.code == "OK") {
                    alert("good");
                } else {
                    alert(retVal.message);
                }

            },
            error       :   function(request, status, error){
                console.log('error_log');
            }
        });
        //alert("성공 완료");
    });
}
$(document).ready(function(){
    bring_myCoordinate('#save', 'coordinate/save')
    $('#marking').click(function (){
        let sendData = $('#myCoordinate').text();   //폼의 이름 값을 변수 안에 담아줌
        let sendData_list = sendData.split("OK");
        let digit2 = [];
        sendData_list.forEach((item, index) => {
            digit2.push({item});
        });
        let Obj_2 = parsing(JSON.stringify(digit2));
        console.log(Obj_2);
         malls = [];
        for (let i = 0; i < Obj_2.length; i++){
            let obj = Obj_2[i];
                malls.push({label: obj["cropsName"], lat: parseFloat(obj["latitude"]), lng: parseFloat(obj["longitude"])},);
            }
        malls.forEach(({ label, lat, lng }) => {
            const marker = new google.maps.Marker({
                position: { lat, lng },
                label,
                map,
            });
        });
        console.log(malls);
    });
});
        window.initMap = function () {
        map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 37.5400456, lng: 126.9921017 },
        zoom: 10,
    });
    };

    </script>
    </body>
</html>
